/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has exclusive access
 * to their data, which is organized under their respective user ID.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring that each user's data is isolated.
 * - /users/{userId}/people/{personId}: Stores personal information.
 * - /users/{userId}/cards/{cardId}: Stores credit card information.
 * - /users/{userId}/purchaseInstallments/{purchaseInstallmentId}: Stores purchase installment details.
 * - /users/{userId}/expenses/{expenseId}: Stores expense records.
 * - /users/{userId}/incomes/{incomeId}: Stores income records.
 *
 * Key Security Decisions:
 * - No public data: All collections require user authentication.
 * - No user listing: Listing users is disallowed for privacy.
 * - Strict ownership: Users can only access data under their own user ID.
 *
 * Denormalization for Authorization:
 * The data model is structured to avoid `get()` calls in security rules.  Ownership is determined
 * by the document's location under `/users/{userId}`, making authorization checks simple and efficient.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper function to check if the requester is the owner of the data.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * Users can create their own document, but cannot read or list other users.
     */
    match /users/{userId} {
      allow get: if false;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * Generic rule for all user-owned subcollections (people, cards, purchases, etc.).
     * Ensures that only the authenticated owner can perform any action on their own documents.
     */
    match /users/{userId}/{collection}/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    /**
     * Card data is considered public and readable by any authenticated user,
     * but writable only by the owner.
     */
    match /cards/{cardId} {
        allow read: if request.auth != null;
        allow write: if false; // Nobody can write to the global cards collection for now
    }
  }
}
