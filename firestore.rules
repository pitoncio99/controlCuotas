/**
 * @fileoverview Firestore Security Rules for CuotaControl App
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model, where each user has complete control over their data.
 *
 * Data Structure:
 * All user-specific data is nested under /users/{userId}, providing clear ownership and separation.
 * Global data like 'cards' is readable by all authenticated users but writable only under specific, secure conditions (or not at all client-side).
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect user privacy.
 * - Data consistency between paths and document content is enforced to prevent unauthorized access.
 * - Most write operations are restricted to the data owner.
 *
 * Authentication Notes:
 * - The error `FirebaseError: Firebase: Error (auth/operation-not-allowed)` suggests an issue with enabling auth providers in the Firebase Console.
 * - Ensure 'Google' is enabled as a sign-in provider.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Rules for user-specific data collections
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // Cards can be read by any authenticated user, but not written to directly by clients.
    // Card creation/updates should be handled by a secure backend function if needed,
    // or pre-populated in the database. For this app, we assume they are added
    // by an admin or a trusted process.
    match /cards/{cardId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create, update, delete: if false; // Prevent client-side modification
    }
  }
}
