/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has exclusive access
 * to their data, which is organized under their respective user ID.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring that each user's data is isolated.
 * - /users/{userId}/people/{personId}: Stores personal information.
 * - /users/{userId}/cards/{cardId}: Stores credit card information.
 * - /users/{userId}/purchaseInstallments/{purchaseInstallmentId}: Stores purchase installment details.
 * - /users/{userId}/expenses/{expenseId}: Stores expense records.
 * - /users/{userId}/incomes/{incomeId}: Stores income records.
 *
 * Key Security Decisions:
 * - No public data: All collections require user authentication.
 * - No user listing: Listing users is disallowed for privacy.
 * - Strict ownership: Users can only access data under their own user ID.
 *
 * Denormalization for Authorization:
 * The data model is structured to avoid `get()` calls in security rules.  Ownership is determined
 * by the document's location under `/users/{userId}`, making authorization checks simple and efficient.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Root collection for user-specific data. Only allows authenticated users.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their own root document.
     * @deny (create) User with ID 'user123' cannot create a root document for 'user456'.
     * @principle Enforces user authentication and ownership for the root user document.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get: if false;
      allow list: if false;

      allow create: if isOwner(userId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages personal information for a user.
     * @path /users/{userId}/people/{personId}
     * @allow (create) User with ID 'user123' can create a person document under their ID.
     * @deny (create) User with ID 'user123' cannot create a person document under 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/people/{personId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages credit card information for a user.
     * @path /users/{userId}/cards/{cardId}
     * @allow (create) User with ID 'user123' can create a card document under their ID.
     * @deny (create) User with ID 'user123' cannot create a card document under 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/cards/{cardId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages purchase installment information for a user.
     * @path /users/{userId}/purchaseInstallments/{purchaseInstallmentId}
     * @allow (create) User with ID 'user123' can create a purchase installment document under their ID.
     * @deny (create) User with ID 'user123' cannot create a purchase installment document under 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/purchaseInstallments/{purchaseInstallmentId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages expense information for a user.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with ID 'user123' can create an expense document under their ID.
     * @deny (create) User with ID 'user123' cannot create an expense document under 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages income information for a user.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (create) User with ID 'user123' can create an income document under their ID.
     * @deny (create) User with ID 'user123' cannot create an income document under 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/incomes/{incomeId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}